<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-bg: #f4f7f6;
            --theme-content-bg: #ffffff;
            --theme-header-start: #007bff;
            --theme-header-end: #0056b3;
            --theme-primary-text: #1c1e21;
            --theme-secondary-text: #606770;
            --theme-accent: #007bff;
            --theme-border: #e9ebee;
            --theme-message-out: #007bff;
            --theme-message-in: #e4e6eb;
            --theme-message-out-text: #ffffff;
            --theme-message-in-text: #1c1e21;
            --theme-success: #28a745;
            --theme-danger: #dc3545;
            --theme-shadow: rgba(0, 0, 0, 0.08);
            --border-radius-sm: 8px;
            --border-radius-md: 16px;
            --transition-speed: 0.3s ease;
        }

        /* --- অ্যানিমেশন --- */
        @keyframes pop-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Global Styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; width: 100%; overflow: hidden; font-family: 'Roboto', sans-serif; background-color: #d1d7db; display: flex; justify-content: center; align-items: center; }
        .icon-btn { background: none; border: none; cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color var(--transition-speed); }
        .icon-btn:hover { background-color: rgba(0,0,0,0.05); }
        .icon-btn svg { fill: var(--theme-secondary-text); width: 24px; height: 24px; }
        
        /* Layout */
        #app-container { width: 100%; height: 100%; max-width: 450px; max-height: 950px; background-color: var(--theme-bg); box-shadow: 0 8px 32px rgba(0,0,0,0.1); border-radius: var(--border-radius-md); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .view, .modal { display: none; width: 100%; height: 100%; flex-direction: column; background-color: var(--theme-bg); }
        .view.active, .modal.active { display: flex; }

        /* Auth View */
        #auth-view { justify-content: center; align-items: center; padding: 2rem; text-align: center; background-color: var(--theme-bg); }
        #auth-view .auth-card { background: var(--theme-content-bg); padding: 2.5rem; border-radius: var(--border-radius-md); box-shadow: 0 4px 12px var(--theme-shadow); width: 100%; animation: pop-in 0.4s ease backwards; }
        #auth-view h1 { color: var(--theme-accent); font-size: 3.5rem; margin-bottom: 2rem; font-weight: 700; }
        .auth-form { width: 100%; display: flex; flex-direction: column; gap: 1rem; }
        .auth-form input { padding: 0.9rem; border: 1px solid var(--theme-border); border-radius: var(--border-radius-sm); font-size: 1rem; transition: border-color var(--transition-speed); }
        .auth-form input:focus { border-color: var(--theme-accent); outline: none; }
        .auth-form button { padding: 0.9rem; background-color: var(--theme-accent); color: white; border: none; border-radius: var(--border-radius-sm); font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color var(--transition-speed); }
        .auth-form button:hover { background-color: var(--theme-header-end); }
        .error-message { color: var(--theme-danger); min-height: 1.2em; font-size: 0.9em; }
        #signup-form { display: none; }

        /* --- Main Header UI Styles --- */
        .main-header { background: linear-gradient(135deg, var(--theme-header-start), var(--theme-header-end)); color: var(--theme-content-bg); flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; }
        .header-top h1 { font-size: 1.5rem; font-weight: 700; color: var(--theme-content-bg); }
        .header-top-icons { display: flex; align-items: center; }
        .header-top-icons .icon-btn svg { fill: var(--theme-content-bg); }
        .header-top-icons .icon-btn:hover { background-color: rgba(255,255,255,0.15); }
        .header-nav { display: flex; justify-content: space-around; }
        .nav-tab { flex: 1; padding: 0.85rem 0; text-align: center; font-weight: 700; color: rgba(255, 255, 255, 0.75); cursor: pointer; border-bottom: 4px solid transparent; transition: all var(--transition-speed); }
        .nav-tab.active { color: var(--theme-content-bg); border-bottom-color: var(--theme-content-bg); }
        .badge { background-color: white; color: var(--theme-accent); border-radius: 50%; font-size: 0.7rem; padding: 2px 6px; margin-left: 5px; font-weight: bold; }
        
        .chat-header { background: var(--theme-content-bg); display: flex; align-items: center; padding: 0.5rem 0.75rem; gap: 0.75rem; color: var(--theme-primary-text); border-bottom: 1px solid var(--theme-border); }
        .chat-header .icon-btn svg { fill: var(--theme-secondary-text); }
        .chat-header-icons { display: flex; align-items: center; margin-left: auto; }
        .chat-header .avatar { background-color: var(--theme-border); width: 40px; height: 40px; border-radius: 50%; overflow: hidden; }
        .chat-header .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .chat-header .contact-info { flex-grow: 1; display: flex; flex-direction: column; }
        .chat-header .contact-info .name { font-weight: 500; font-size: 1.15rem; }
        .chat-header .contact-info .status-text { font-size: 0.8em; color: var(--theme-secondary-text); }

        #main-content { flex-grow: 1; overflow-y: auto; overflow-x: hidden; background-color: var(--theme-content-bg); }
        .content-panel { display: none; }
        .content-panel.active { display: block; }
        
        .list-item { display: flex; align-items: center; padding: 0.8rem 1rem; border-bottom: 1px solid var(--theme-border); cursor: pointer; gap: 1rem; transition: background-color var(--transition-speed); }
        .list-item:hover { background-color: var(--theme-bg); }
        .list-item .avatar { background-color: var(--theme-border); width: 54px; height: 54px; border-radius: 50%; overflow: hidden; flex-shrink: 0; }
        .list-item .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .list-item .details { flex-grow: 1; min-width: 0; }
        .list-item .details .name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item .details .subtext { color: var(--theme-secondary-text); font-size: 0.9em; }
        .list-item .actions { display: flex; gap: 0.5rem; margin-left: auto; }
        .list-item .actions button { padding: 0.5rem 1rem; border: none; border-radius: var(--border-radius-sm); color: white; cursor: pointer; }
        .accept-btn { background-color: var(--theme-success); }
        .reject-btn { background-color: var(--theme-danger); }
        .list-item .unread-badge { background-color: var(--theme-success); color: white; border-radius: 50%; font-size: 0.75rem; font-weight: bold; padding: 4px 8px; margin-left: auto; flex-shrink: 0; }

        /* Chat View */
        #chat-view { background: var(--theme-bg); }
        #chat-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; }
        .message-bubble { max-width: 75%; padding: 0.75rem 1.1rem; border-radius: 22px; word-wrap: break-word; line-height: 1.4; box-shadow: 0 1px 2px var(--theme-shadow); }
        .message-sent { align-self: flex-end; background-color: var(--theme-message-out); color: var(--theme-message-out-text); border-bottom-right-radius: 6px; }
        .message-received { align-self: flex-start; background-color: var(--theme-message-in); color: var(--theme-message-in-text); border-bottom-left-radius: 6px; }
        #chat-input-container { display: flex; align-items: center; padding: 0.75rem; gap: 0.75rem; background-color: var(--theme-content-bg); border-top: 1px solid var(--theme-border); }
        #chat-input { flex-grow: 1; padding: 0.9rem; border: none; border-radius: 24px; font-size: 1rem; background-color: var(--theme-bg); }
        #chat-input:focus { outline: none; }
        #chat-send-btn { background-color: var(--theme-accent); border-radius: 50%; padding: 0.9rem; }
        #chat-send-btn svg { fill: white; }

        /* Call View */
        .call-view { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #222; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; background-color: #111; }
        #local-video { position: absolute; bottom: 150px; right: 20px; width: 120px; height: 160px; border-radius: var(--border-radius-sm); z-index: 3; border: 2px solid rgba(255,255,255,0.2); }
        .call-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: space-between; padding: 2rem; z-index: 2; background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 40%, transparent 60%, rgba(0,0,0,0.8) 100%); }
        .caller-info { text-align: center; color: white; }
        .caller-info .avatar { margin: 0 auto; width: 120px; height: 120px; border-radius: 50%; background-color: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .caller-info .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .caller-info .name { font-size: 2.4rem; margin-top: 1rem; font-weight: 500; }
        .caller-info .status { font-size: 1.1rem; min-height: 20px; }
        .call-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; padding-bottom: 2rem; }
        .call-controls .icon-btn { width: 60px; height: 60px; background-color: rgba(255, 255, 255, 0.2); }
        .call-controls .icon-btn svg { fill: white; }
        .call-controls .icon-btn.active { background-color: var(--theme-accent); }
        .end-call-btn, .reject-call-btn { background-color: var(--theme-danger) !important; }
        .end-call-btn { width: 70px !important; height: 70px !important; }
        
        /* Modal Styles */
        .modal { position: absolute; top: 0; left: 0; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; padding: 1rem; z-index: 10; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: var(--border-radius-md); width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 1rem; box-shadow: 0 8px 32px rgba(0,0,0,0.15); animation: pop-in var(--transition-speed) backwards; }
        #incoming-call-modal .caller-info .avatar { width: 100px; height: 100px; }
        #incoming-call-modal .caller-info { color: #1c1e21; }
        #incoming-call-modal .accept-call-btn { background-color: var(--theme-success); }
        
        /* --- Profile Modal UI --- */
        #profile-view-modal .modal-content { padding: 0; overflow: hidden; }
        #profile-view-modal h2 { font-size: 1.2rem; padding: 1.2rem 1.5rem; margin: 0; border-bottom: 1px solid var(--theme-border); }
        .profile-header { text-align: center; padding: 2rem 1rem; background-color: var(--theme-bg); }
        #profile-image-display { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--theme-content-bg); box-shadow: 0 2px 4px var(--theme-shadow); }
        #profile-name-container { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
        #profile-name-container h3 { font-size: 1.5rem; margin: 0; color: var(--theme-primary-text); }
        #profile-name-container #edit-name-btn { background: none; border: none; cursor: pointer; padding: 4px; }
        #profile-name-container #edit-name-btn svg { width: 20px; height: 20px; fill: var(--theme-secondary-text); }
        #profile-username-display { color: var(--theme-secondary-text); margin-top: 0.25rem; font-size: 1rem; }
        #user-info { padding: 0 1.5rem 1rem; }
        #profile-view-modal .profile-field { padding: 1rem 0; border-bottom: 1px solid var(--theme-border); }
        #profile-view-modal .profile-field:last-child { border-bottom: none; }
        #profile-view-modal .profile-field strong { display: block; margin-bottom: 8px; color: var(--theme-secondary-text); font-size: 0.8rem; text-transform: uppercase; }
        #profile-view-modal .profile-field span { font-size: 1rem; color: var(--theme-primary-text); }
        #profile-view-modal .edit-name-container { display: none; gap: 10px; align-items: center; margin-top: 0.5rem; }
        #profile-view-modal input[type="text"], #profile-view-modal input[type="url"] { width: 100%; padding: 0.7rem; border: 1px solid var(--theme-border); border-radius: var(--border-radius-sm); font-size: 1rem; background-color: var(--theme-bg); }
        #profile-view-modal button { border-radius: var(--border-radius-sm); padding: 0.7rem 1rem; font-weight: 500; font-size: 0.9rem; cursor: pointer; border: none; }
        #profile-view-modal #save-name-btn, #profile-view-modal #save-image-btn { background-color: var(--theme-accent); color: white; }
        .profile-actions { padding: 0 1.5rem 1.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .profile-actions button { width: 100%; }
        #logout-btn { background-color: var(--theme-danger); color: white; }
        #close-profile-modal-btn { background-color: var(--theme-bg); color: var(--theme-primary-text); }

    </style>
</head>
<body>
    <div id="app-container">
        <!-- Auth View -->
        <div id="auth-view" class="view active">
            <div class="auth-card">
                <h1>SMS</h1>
                <form id="login-form" class="auth-form">
                    <h2>Login</h2>
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <div id="login-error" class="error-message"></div>
                    <button type="submit">Login</button>
                    <p>No account? <a href="#" id="show-signup">Sign Up</a></p>
                </form>
                <form id="signup-form" class="auth-form" style="display: none;">
                    <h2>Sign Up</h2>
                    <input type="text" id="signup-name" placeholder="Full Name" required>
                    <input type="text" id="signup-username" placeholder="Username (Your Unique ID)" required>
                    <input type="email" id="signup-email" placeholder="Email" required>
                    <input type="password" id="signup-password" placeholder="Password" required>
                    <input type="url" id="signup-image-url" placeholder="Profile Image URL (Optional)">
                    <div id="signup-error" class="error-message"></div>
                    <button type="submit">Sign Up</button>
                    <p>Have an account? <a href="#" id="show-login">Log In</a></p>
                </form>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-view" class="view">
            <header class="main-header">
                <div class="header-top">
                    <h1>SMS</h1>
                    <div class="header-top-icons">
                        <button id="add-friend-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg></button>
                        <button id="menu-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg></button>
                    </div>
                </div>
                <nav class="header-nav">
                    <div id="nav-home" class="nav-tab active">CHATS<span class="badge" id="chats-badge" style="display: none;"></span></div>
                    <div id="nav-notifications" class="nav-tab">UPDATES<span class="badge" id="updates-badge" style="display: none;"></span></div>
                    <div id="nav-calls" class="nav-tab">CALLS</div>
                </nav>
            </header>
            <main id="main-content">
                <div id="home-content" class="content-panel active"></div>
                <div id="notifications-content" class="content-panel"></div>
                <div id="calls-content" class="content-panel"></div>
            </main>
        </div>

        <!-- Chat View -->
        <div id="chat-view" class="view">
             <header class="chat-header">
                <button id="back-to-main-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg></button>
                <div class="avatar" id="chat-header-avatar"></div>
                <div class="contact-info"></div>
                <div class="chat-header-icons">
                    <button id="voice-call-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.02.74-.25 1.02l-2.2 2.2z"></path></svg></button>
                    <button id="video-call-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"></path></svg></button>
                </div>
            </header>
            <div id="chat-messages"></div>
            <form id="chat-input-container">
                <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off">
                <button type="submit" id="chat-send-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button>
            </form>
        </div>
        
        <!-- Video & Voice Call Views -->
        <div id="video-call-view" class="view call-view">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div class="call-overlay">
                <div id="video-caller-info" class="caller-info">
                    <div class="avatar"></div> <div class="name"></div> <div class="status"></div>
                </div>
                <div class="call-controls">
                    <button id="toggle-video-mute-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3zm-1 11.97V18h2v-5.03A5.002 5.002 0 0 1 7 9H5a7 7 0 0 0 6 6.92V19h2v-2.08A7 7 0 0 0 19 9h-2a5.002 5.002 0 0 1-4 3.97z"></path></svg></button>
                    <button id="toggle-video-speaker-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg></button>
                    <button id="toggle-video-camera-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"></path></svg></button>
                    <button id="video-end-call-btn" class="icon-btn end-call-btn"><svg viewBox="0 0 24 24" transform="rotate(135)"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.02.74-.25 1.02l-2.2 2.2z"></path></svg></button>
                </div>
            </div>
        </div>
        <div id="voice-call-view" class="view call-view">
            <audio id="remote-audio" autoplay></audio>
            <div class="call-overlay">
                <div id="voice-caller-info" class="caller-info">
                    <div class="avatar"></div> <div class="name"></div> <div class="status"></div>
                </div>
                <div class="call-controls">
                    <button id="toggle-voice-mute-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3zm-1 11.97V18h2v-5.03A5.002 5.002 0 0 1 7 9H5a7 7 0 0 0 6 6.92V19h2v-2.08A7 7 0 0 0 19 9h-2a5.002 5.002 0 0 1-4 3.97z"></path></svg></button>
                    <button id="toggle-voice-speaker-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg></button>
                    <button id="voice-end-call-btn" class="icon-btn end-call-btn"><svg viewBox="0 0 24 24" transform="rotate(135)"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.02.74-.25 1.02l-2.2 2.2z"></path></svg></button>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="add-friend-modal" class="modal">
            <div class="modal-content">
                <h2>Add Friend</h2><p>Enter your friend's unique Username.</p>
                <input type="text" id="friend-id-input" placeholder="Friend's Username">
                <button id="send-friend-request-btn">Send Request</button>
                <button id="cancel-add-friend-btn" class="modal-cancel-btn">Cancel</button>
            </div>
        </div>

        <div id="profile-view-modal" class="modal">
            <div class="modal-content">
                <h2>Profile & Settings</h2>
                <div class="profile-header">
                    <img id="profile-image-display" src="" alt="Profile">
                    <div id="profile-name-container">
                        <h3 id="profile-name-display"></h3>
                        <button id="edit-name-btn" class="icon-btn">
                            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>
                        </button>
                    </div>
                     <p id="profile-username-display"></p>
                </div>

                <div id="user-info">
                     <div class="edit-name-container profile-field">
                         <strong>Edit Name</strong>
                         <input type="text" id="profile-name-input" placeholder="Enter new name">
                         <button id="save-name-btn">Save</button>
                    </div>
                    <div class="profile-field">
                        <strong>Username (ID)</strong>
                        <span id="profile-username-display-field"></span>
                    </div>
                    <div class="profile-field">
                        <strong>Email</strong>
                        <span id="profile-email-display"></span>
                    </div>
                    <div class="profile-field">
                        <strong>Update Profile Image</strong>
                        <input type="url" id="profile-image-input" placeholder="New Image URL">
                        <button id="save-image-btn" style="margin-top: 8px;">Save Image</button>
                    </div>
                </div>

                <div class="profile-actions">
                    <button id="logout-btn">Logout</button>
                    <button id="close-profile-modal-btn" class="modal-cancel-btn">Close</button>
                </div>
            </div>
        </div>

        <div id="incoming-call-modal" class="modal">
            <div class="modal-content">
                <div id="incoming-caller-info" class="caller-info">
                    <div class="avatar"></div><div class="name"></div><div class="status"></div>
                </div>
                <div class="call-controls">
                    <button class="icon-btn reject-call-btn" id="reject-call-btn"><svg viewBox="0 0 24 24" transform="rotate(135)"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.02.74-.25 1.02l-2.2 2.2z"></path></svg></button>
                    <button class="icon-btn accept-call-btn" id="accept-call-btn"><svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.02.74-.25 1.02l-2.2 2.2z"></path></svg></button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTE: Place 'ringtone.mp3' and 'outgoing.mp3' in the same folder as this HTML file -->
    <audio id="ringtone" loop src="ringtone.mp3"></audio>
    <audio id="outgoing-call-tone" loop src="outgoing.mp3"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = { 
            apiKey: "AIzaSyBkjWUY9kWP28Hgu2HDd9jge_d8-YV5RI4", 
            authDomain: "calling-app-6df8a.firebaseapp.com", 
            databaseURL: "https://calling-app-6df8a-default-rtdb.firebaseio.com", 
            projectId: "calling-app-6df8a", 
            storageBucket: "calling-app-6df8a.firebasestorage.app", 
            messagingSenderId: "756155662995", 
            appId: "1:756155662995:web:46d61e5f14c3224ceac366" 
        };
        // -----------------------------------------

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null, currentChatPartner = null, currentChatId = null, currentCallData = null;
        let peerConnection, localStream, remoteStream, callTimerInterval, callStartTime;
        const peerConnectionConfig = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] };
        const DEFAULT_PROFILE_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2EwYTBiMiI+PHBhdGggZD0iTTEyIDJDNi44MiAyIDIgNi44MiAyIDEyczQuODIgMTAgMTAgMTAgMTAtNC44MiAxMC0xMFMxNy4xOCAyIDEyIDJ6bTAgM2MxLjY2IDAgMyAxLjM0IDMgMyAwIDEuNjYtMS4zNCAzLTMgMy0xLjY2IDAtMy0xLjM0LTMtMyAwLTEuNjYgMS4zNC0zIDMtM3ptMCAxNC4yYy0yLjUgMC00LjcxLTEuMjgtNi0zLjIyLjAzLTEuOTkgNC0zLjA4IDYtMy4wOHM1Ljk3IDEuMDkgNiAzLjA4Yy0xLjI5IDEuOTQtMy41IDMuMjItNiAzLjIyeiIvPjwvc3ZnPg==';
        
        const views = document.querySelectorAll('.view'), modals = document.querySelectorAll('.modal'), contentPanels = document.querySelectorAll('.content-panel');
        function showView(id) { views.forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function showModal(id, show = true) { document.getElementById(id).classList.toggle('active', show); }
        function showPanel(id) { contentPanels.forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active')); document.getElementById(`nav-${id.split('-')[0]}`).classList.add('active'); }
        function formatTimeAgo(ts) { const secs = Math.floor((Date.now() - ts) / 1000); if (secs < 60) return "just now"; let i = Math.floor(secs / 2592000); if (i >= 1) return i + "mo ago"; i = Math.floor(secs / 86400); if (i >= 1) return i + "d ago"; i = Math.floor(secs / 3600); if (i >= 1) return i + "h ago"; i = Math.floor(secs / 60); if (i >= 1) return i + "m ago"; return "just now"; }
        function formatCallDuration(ms) { const s = Math.floor(ms / 1000); return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                if (user) { db.ref(`users/${user.uid}`).on('value', snap => { if (snap.exists()) { currentUser = { uid: user.uid, ...snap.val() }; initializeAppForUser(); showView('main-view'); showPanel('home-content'); } }); } 
                else { currentUser = null; cleanupListeners(); showView('auth-view'); }
            });
            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').style.display = 'none'; document.getElementById('signup-form').style.display = 'flex'; });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('signup-form').style.display = 'none'; document.getElementById('login-form').style.display = 'flex'; });
            document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => document.getElementById('login-error').textContent = err.message); });
            document.getElementById('signup-form').addEventListener('submit', handleSignUp);
            document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut(); showModal('profile-view-modal', false); });
            ['home', 'notifications', 'calls'].forEach(panel => document.getElementById(`nav-${panel}`).addEventListener('click', () => showPanel(`${panel}-content`)));
            document.getElementById('add-friend-btn').addEventListener('click', () => showModal('add-friend-modal'));
            document.getElementById('cancel-add-friend-btn').addEventListener('click', () => showModal('add-friend-modal', false));
            document.getElementById('send-friend-request-btn').addEventListener('click', sendFriendRequest);
            document.getElementById('menu-btn').addEventListener('click', openProfileModal);
            document.getElementById('close-profile-modal-btn').addEventListener('click', () => showModal('profile-view-modal', false));
            document.getElementById('edit-name-btn').addEventListener('click', () => { document.querySelector('.edit-name-container').style.display = 'block'; document.getElementById('profile-name-input').value = currentUser.name; });
            document.getElementById('save-name-btn').addEventListener('click', updateUserProfileName);
            document.getElementById('save-image-btn').addEventListener('click', updateUserProfileImage);
            document.getElementById('back-to-main-btn').addEventListener('click', () => { showView('main-view'); if (currentChatId) db.ref(`messages/${currentChatId}`).off(); currentChatId = null; });
            document.getElementById('chat-input-container').addEventListener('submit', sendChatMessage);
            document.getElementById('voice-call-btn').addEventListener('click', () => startCall(false));
            document.getElementById('video-call-btn').addEventListener('click', () => startCall(true));
            document.getElementById('accept-call-btn').addEventListener('click', acceptCall);
            document.getElementById('reject-call-btn').addEventListener('click', rejectCall);
            document.getElementById('video-end-call-btn').addEventListener('click', () => endCall());
            document.getElementById('voice-end-call-btn').addEventListener('click', () => endCall());
            ['video', 'voice'].forEach(type => {
                document.getElementById(`toggle-${type}-mute-btn`).addEventListener('click', toggleMute);
                document.getElementById(`toggle-${type}-speaker-btn`).addEventListener('click', toggleSpeaker);
            });
            document.getElementById('toggle-video-camera-btn').addEventListener('click', toggleVideo);
        });

        function initializeAppForUser() { setupPresenceSystem(); listenForContacts(); listenForFriendRequests(); listenForIncomingCalls(); }
        function cleanupListeners() { if (currentUser) { ['users', 'requests', 'activeCalls', 'status', `userChats/${currentUser.uid}`].forEach(path => db.ref(path).off()); if (currentChatId) db.ref(`messages/${currentChatId}`).off(); } }
        function setupPresenceSystem() { const statusRef = db.ref(`/status/${currentUser.uid}`); db.ref('.info/connected').on('value', snap => { if (snap.val() === true) { statusRef.onDisconnect().set({ isOnline: false, lastSeen: firebase.database.ServerValue.TIMESTAMP }).then(() => statusRef.set({ isOnline: true, lastSeen: firebase.database.ServerValue.TIMESTAMP })); } }); }

        async function handleSignUp(e) { e.preventDefault(); const name = document.getElementById('signup-name').value.trim(); const username = document.getElementById('signup-username').value.trim().toLowerCase(); const email = document.getElementById('signup-email').value.trim(); const password = document.getElementById('signup-password').value; const imageUrl = document.getElementById('signup-image-url').value.trim(); const errorEl = document.getElementById('signup-error'); if (!/^[a-z0-9_]{3,15}$/.test(username)) { return errorEl.textContent = "Username: 3-15 chars (a-z, 0-9, _)."; } if (!name) { return errorEl.textContent = "Please enter your full name."; } const usernameSnap = await db.ref(`usernames/${username}`).once('value'); if (usernameSnap.exists()) { return errorEl.textContent = "This username is already taken."; } try { const cred = await auth.createUserWithEmailAndPassword(email, password); const userProfile = { name, username, email, imageUrl: imageUrl || "" }; await db.ref(`users/${cred.user.uid}`).set(userProfile); await db.ref(`usernames/${username}`).set(cred.user.uid); } catch (err) { errorEl.textContent = err.message; } }
        
        function openProfileModal() { 
            document.getElementById('profile-image-display').src = currentUser.imageUrl || DEFAULT_PROFILE_IMAGE; 
            document.getElementById('profile-name-display').textContent = currentUser.name; 
            document.getElementById('profile-username-display').textContent = `@${currentUser.username}`; 
            document.getElementById('profile-username-display-field').textContent = `@${currentUser.username}`;
            document.getElementById('profile-email-display').textContent = currentUser.email; 
            document.querySelector('.edit-name-container').style.display = 'none'; 
            showModal('profile-view-modal'); 
        }
        function updateUserProfileName() { const newName = document.getElementById('profile-name-input').value.trim(); if (newName && newName !== currentUser.name) { db.ref(`users/${currentUser.uid}/name`).set(newName); document.querySelector('.edit-name-container').style.display = 'none'; } }
        function updateUserProfileImage() { const newUrl = document.getElementById('profile-image-input').value.trim(); if (newUrl) { db.ref(`users/${currentUser.uid}/imageUrl`).set(newUrl).then(() => { document.getElementById('profile-image-input').value = ''; alert('Image updated!'); }); } }
        
        async function sendFriendRequest() { const friendUsername = document.getElementById('friend-id-input').value.trim().toLowerCase(); if (!friendUsername || friendUsername === currentUser.username) return; const usernameSnap = await db.ref(`usernames/${friendUsername}`).once('value'); if (usernameSnap.exists()) { const uid = usernameSnap.val(); if (currentUser.contacts && currentUser.contacts[uid]) return alert('Already in contacts.'); db.ref(`requests/${uid}/${currentUser.uid}`).set({ fromName: currentUser.name, fromUid: currentUser.uid, fromImageUrl: currentUser.imageUrl || "" }); showModal('add-friend-modal', false); alert('Friend request sent!'); } else { alert('Username not found.'); } }
        function listenForFriendRequests() { db.ref(`requests/${currentUser.uid}`).on('value', snap => { const container = document.getElementById('notifications-content'); const badge = document.getElementById('updates-badge'); container.innerHTML = '<h2>Friend Requests</h2>'; const requests = snap.val(); if (requests && Object.keys(requests).length > 0) { badge.textContent = Object.keys(requests).length; badge.style.display = 'inline-block'; Object.entries(requests).forEach(([uid, req]) => { const el = document.createElement('div'); el.className = 'list-item'; el.innerHTML = `<div class="avatar"><img src="${req.fromImageUrl || DEFAULT_PROFILE_IMAGE}" alt=""></div> <div class="details"><div class="name">${req.fromName}</div><div class="subtext">Wants to be your contact.</div></div> <div class="actions"><button class="accept-btn" data-uid="${uid}">Accept</button><button class="reject-btn" data-uid="${uid}">Reject</button></div>`; container.appendChild(el); }); } else { badge.style.display = 'none'; container.innerHTML += '<p>No new friend requests.</p>'; } document.querySelectorAll('.accept-btn').forEach(b => b.onclick = () => handleFriendRequest(b.dataset.uid, true)); document.querySelectorAll('.reject-btn').forEach(b => b.onclick = () => handleFriendRequest(b.dataset.uid, false)); }); }
        function handleFriendRequest(fromUid, accepted) { db.ref(`requests/${currentUser.uid}/${fromUid}`).remove(); if (accepted) { db.ref(`users/${fromUid}`).once('value', snap => { const friendData = snap.val(); const myUid = currentUser.uid; const updates = {}; updates[`/users/${myUid}/contacts/${fromUid}`] = { name: friendData.name, imageUrl: friendData.imageUrl || "" }; updates[`/users/${fromUid}/contacts/${myUid}`] = { name: currentUser.name, imageUrl: currentUser.imageUrl || "" }; db.ref().update(updates); }); } }

        function listenForContacts() { db.ref(`users/${currentUser.uid}/contacts`).on('value', snap => { const container = document.getElementById('home-content'); container.innerHTML = ''; if (!snap.exists()) return container.innerHTML = '<p style="padding:20px;text-align:center;">Add friends to start chatting.</p>'; snap.forEach(child => { const contact = child.val(); const uid = child.key; const el = document.createElement('div'); el.className = 'list-item'; el.dataset.uid = uid; el.onclick = () => openChat(uid, contact); el.innerHTML = `<div class="avatar"><img src="${contact.imageUrl || DEFAULT_PROFILE_IMAGE}" alt=""></div><div class="details"><div class="name">${contact.name}</div><div class="subtext" id="status-${uid}">...</div></div>`; container.appendChild(el); db.ref(`/status/${uid}`).on('value', statusSnap => { const subtext = document.getElementById(`status-${uid}`); if (!subtext) return; const status = statusSnap.val(); if (status && status.isOnline) { subtext.textContent = 'Online'; subtext.style.color = 'var(--theme-success)'; } else if (status) { subtext.textContent = `Last seen ${formatTimeAgo(status.lastSeen)}`; subtext.style.color = 'var(--theme-secondary-text)'; } }); }); listenForUnreadCounts(); }); }
        function listenForUnreadCounts() { const userChatsRef = db.ref(`userChats/${currentUser.uid}`); userChatsRef.on('value', snap => { snap.forEach(child => { const chatId = child.key; const chatData = child.val(); const listItem = document.querySelector(`.list-item[data-uid='${chatId.replace(currentUser.uid, '').replace('_', '')}']`); if (listItem) { let badge = listItem.querySelector('.unread-badge'); if (chatData.unreadCount > 0) { if (!badge) { badge = document.createElement('span'); badge.className = 'unread-badge'; listItem.appendChild(badge); } badge.textContent = chatData.unreadCount; } else if (badge) { badge.remove(); } } }); }); }
        
        function openChat(partnerUid, contact) {
            currentChatPartner = { uid: partnerUid, ...contact }; currentChatId = [currentUser.uid, partnerUid].sort().join('_');
            const avatarDiv = document.getElementById('chat-header-avatar'); avatarDiv.innerHTML = `<img src="${contact.imageUrl || DEFAULT_PROFILE_IMAGE}" alt="${contact.name}">`;
            const infoDiv = document.querySelector('#chat-view .contact-info'); infoDiv.innerHTML = `<div class="name">${contact.name}</div><div class="status-text" id="chat-status-${partnerUid}">...</div>`;
            db.ref(`/status/${partnerUid}`).on('value', snap => { const el = document.getElementById(`chat-status-${partnerUid}`); if (el) { const s = snap.val(); if (s && s.isOnline) el.textContent = 'Online'; else if (s) el.textContent = `Last seen ${formatTimeAgo(s.lastSeen)}`; else el.textContent = 'Offline'; } });
            db.ref(`userChats/${currentUser.uid}/${currentChatId}/unreadCount`).set(0);
            const msgContainer = document.getElementById('chat-messages'); db.ref(`messages/${currentChatId}`).orderByChild('timestamp').on('value', snap => { msgContainer.innerHTML = ''; snap.forEach(child => { const msg = child.val(); const bubble = document.createElement('div'); bubble.className = `message-bubble ${msg.sender === currentUser.uid ? 'message-sent' : 'message-received'}`; bubble.textContent = msg.text; msgContainer.appendChild(bubble); }); msgContainer.scrollTop = msgContainer.scrollHeight; }); showView('chat-view');
        }
        function sendChatMessage(e) { e.preventDefault(); const input = document.getElementById('chat-input'); const text = input.value.trim(); if (text && currentChatId) { db.ref(`messages/${currentChatId}`).push({ text, sender: currentUser.uid, timestamp: firebase.database.ServerValue.TIMESTAMP }); db.ref(`userChats/${currentChatPartner.uid}/${currentChatId}/unreadCount`).transaction(count => (count || 0) + 1); input.value = ''; } }
        
        // --- FINAL, ROBUST WEBRTC CALLING LOGIC ---

        async function createPeerConnection(callRef, role) {
            peerConnection = new RTCPeerConnection(peerConnectionConfig);

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            remoteStream = new MediaStream();
            if (currentCallData.isVideo) {
                document.getElementById('remote-video').srcObject = remoteStream;
            } else {
                document.getElementById('remote-audio').srcObject = remoteStream;
            }
            peerConnection.ontrack = event => {
                event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
            };

            const candidateQueue = [];
            let remoteDescriptionSet = false;

            const otherRole = role === 'caller' ? 'callee' : 'caller';
            const remoteCandidatesRef = callRef.child(`${otherRole}Candidates`);
            remoteCandidatesRef.on('child_added', snapshot => {
                if (snapshot.exists()) {
                    const candidate = new RTCIceCandidate(snapshot.val());
                    if (remoteDescriptionSet) {
                        peerConnection.addIceCandidate(candidate).catch(e => console.error("Error adding received ICE candidate:", e));
                    } else {
                        candidateQueue.push(candidate);
                    }
                }
            });

            peerConnection.addEventListener('remotedescriptionset', () => {
                remoteDescriptionSet = true;
                candidateQueue.forEach(candidate => peerConnection.addIceCandidate(candidate).catch(e => console.error("Error adding queued ICE candidate:", e)));
                candidateQueue.length = 0;
            });

            const localCandidatesRef = callRef.child(`${role}Candidates`);
            peerConnection.onicecandidate = event => {
                if (event.candidate) localCandidatesRef.push(event.candidate.toJSON());
            };

            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') {
                    console.log("Call connected successfully!");
                    document.getElementById('outgoing-call-tone').pause();
                    callStartTime = Date.now();
                    updateCallUI(null, formatCallDuration(0));
                    callTimerInterval = setInterval(() => {
                        if (callStartTime) updateCallUI(null, formatCallDuration(Date.now() - callStartTime));
                    }, 1000);
                }
                if (['failed', 'disconnected', 'closed'].includes(peerConnection.connectionState)) {
                    endCall(`Call state changed to ${peerConnection.connectionState}.`);
                }
            };
        }

        async function startCall(isVideo) {
            if (currentCallData) return;
            const calleeId = currentChatPartner.uid;
            const callRef = db.ref(`activeCalls/${calleeId}`);
            
            currentCallData = { 
                isVideo, isCaller: true, callRef,
                caller: { uid: currentUser.uid, name: currentUser.name, imageUrl: currentUser.imageUrl }, 
                callee: { uid: calleeId, name: currentChatPartner.name, imageUrl: currentChatPartner.imageUrl }
            };
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
                if (isVideo) document.getElementById('local-video').srcObject = localStream;

                await createPeerConnection(callRef, 'caller');

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                await callRef.set({ offer, isVideo, callerInfo: currentCallData.caller });
                callRef.onDisconnect().remove();

                const answerListener = callRef.on('value', async (snap) => {
                    const data = snap.val();
                    if (!data && currentCallData) return endCall("Call cancelled.");
                    if (data?.answer && peerConnection.signalingState !== 'stable') {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                        peerConnection.dispatchEvent(new Event('remotedescriptionset'));
                    }
                });
                currentCallData.answerListener = answerListener;

                showView(isVideo ? 'video-call-view' : 'voice-call-view');
                updateCallUI(currentCallData.callee, 'Ringing...');
                document.getElementById('outgoing-call-tone').play();
            } catch (err) {
                console.error("Start call error:", err);
                endCall("Failed to start the call.");
            }
        }

        function listenForIncomingCalls() {
            const incomingCallRef = db.ref(`activeCalls/${currentUser.uid}`);
            incomingCallRef.on('value', snap => {
                const callData = snap.val();
                if (callData?.offer && !currentCallData) {
                    currentCallData = {
                        isVideo: callData.isVideo, isCaller: false, callRef: incomingCallRef, offer: callData.offer,
                        caller: callData.callerInfo,
                        callee: { uid: currentUser.uid, name: currentUser.name, imageUrl: currentUser.imageUrl }
                    };
                    const modalInfo = document.getElementById('incoming-caller-info');
                    modalInfo.querySelector('.avatar').innerHTML = `<img src="${currentCallData.caller.imageUrl || DEFAULT_PROFILE_IMAGE}" alt="">`;
                    modalInfo.querySelector('.name').textContent = currentCallData.caller.name;
                    modalInfo.querySelector('.status').textContent = `Incoming ${callData.isVideo ? 'Video' : 'Voice'} Call...`;
                    showModal('incoming-call-modal');
                    document.getElementById('ringtone').play();
                }
            });
        }
        
        async function acceptCall() {
            if (!currentCallData || currentCallData.isCaller) return;
            showModal('incoming-call-modal', false);
            document.getElementById('ringtone').pause();
            const callRef = currentCallData.callRef;
            callRef.onDisconnect().cancel();

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: currentCallData.isVideo, audio: true });
                if (currentCallData.isVideo) document.getElementById('local-video').srcObject = localStream;
                
                await createPeerConnection(callRef, 'callee');
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(currentCallData.offer));
                peerConnection.dispatchEvent(new Event('remotedescriptionset'));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                await callRef.update({ answer });
                
                const endListener = callRef.on('value', snap => { if (!snap.exists()) endCall("The other user ended the call."); });
                currentCallData.endListener = endListener;
                
                showView(currentCallData.isVideo ? 'video-call-view' : 'voice-call-view');
                updateCallUI(currentCallData.caller, 'Connecting...');
            } catch (err) {
                console.error("Accept call error:", err);
                endCall("Failed to accept the call.");
            }
        }
        
        function rejectCall() {
            showModal('incoming-call-modal', false);
            document.getElementById('ringtone').pause();
            if (currentCallData?.callRef) currentCallData.callRef.remove();
            currentCallData = null;
        }

        function endCall(reason = "Call ended.") {
            if (!currentCallData) return;
            console.log(reason);

            const { callRef, answerListener, endListener } = currentCallData;
            
            currentCallData = null; 

            if (callRef) {
                if (answerListener) callRef.off('value', answerListener);
                if (endListener) callRef.off('value', endListener);
                callRef.child('callerCandidates').off();
                callRef.child('calleeCandidates').off();
                callRef.remove();
            }
            
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            
            if (peerConnection) {
                peerConnection.ontrack = null;
                peerConnection.onicecandidate = null;
                peerConnection.onconnectionstatechange = null;
                peerConnection.close();
                peerConnection = null;
            }

            clearInterval(callTimerInterval);
            callTimerInterval = null;
            callStartTime = null;
            
            ['ringtone', 'outgoing-call-tone'].forEach(id => {
                const el = document.getElementById(id);
                el.pause(); el.currentTime = 0;
            });
            
            localStream = remoteStream = null;
            document.getElementById('remote-video').srcObject = null;
            document.getElementById('local-video').srcObject = null;
            document.getElementById('remote-audio').srcObject = null;

            showView('main-view');
        }

        function updateCallUI(partner, status) {
            if (!currentCallData) return;
            const viewId = currentCallData.isVideo ? 'video' : 'voice';
            const infoDiv = document.getElementById(`${viewId}-caller-info`);
            const otherParty = currentCallData.isCaller ? currentCallData.callee : currentCallData.caller;
            const person = partner || otherParty;
            
            infoDiv.querySelector('.name').textContent = person.name;
            infoDiv.querySelector('.avatar').innerHTML = `<img src="${person.imageUrl || DEFAULT_PROFILE_IMAGE}" alt="">`;
            if (status) infoDiv.querySelector('.status').textContent = status;
        }

        function toggleMute(e) { if(localStream) { localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled; e.currentTarget.classList.toggle('active'); } }
        function toggleVideo(e) { if(localStream && currentCallData?.isVideo) { const track = localStream.getVideoTracks()[0]; track.enabled = !track.enabled; e.currentTarget.classList.toggle('active'); document.getElementById('local-video').style.display = track.enabled ? 'block' : 'none'; } }
        function toggleSpeaker(e) { e.currentTarget.classList.toggle('active'); console.log("Speaker toggle feature not implemented."); }

    </script>
</body>
</html>
